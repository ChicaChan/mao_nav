---
import { getSortedPosts } from "@/utils/content-utils";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import { siteConfig } from "@/config/siteConfig";
import WidgetLayout from "./WidgetLayout.astro";

interface Props {
  class?: string;
  style?: string;
}

const { class: className, style } = Astro.props;

const posts = await getSortedPosts();

const postDateMap = new Map<string, { id: string; title: string }[]>();
posts.forEach((post) => {
  const date = new Date(post.data.published);
  const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")}`;
  const existingPosts = postDateMap.get(dateKey) || [];
  postDateMap.set(dateKey, [...existingPosts, { id: post.id, title: post.data.title }]);
});

const allPostsData = posts.map((post) => ({
  id: post.id,
  title: post.data.title,
  published: post.data.published.getTime(),
}));

const monthNames = [
  i18n(I18nKey.calendarJanuary),
  i18n(I18nKey.calendarFebruary),
  i18n(I18nKey.calendarMarch),
  i18n(I18nKey.calendarApril),
  i18n(I18nKey.calendarMay),
  i18n(I18nKey.calendarJune),
  i18n(I18nKey.calendarJuly),
  i18n(I18nKey.calendarAugust),
  i18n(I18nKey.calendarSeptember),
  i18n(I18nKey.calendarOctober),
  i18n(I18nKey.calendarNovember),
  i18n(I18nKey.calendarDecember),
];

const weekDays = [
  i18n(I18nKey.calendarSunday),
  i18n(I18nKey.calendarMonday),
  i18n(I18nKey.calendarTuesday),
  i18n(I18nKey.calendarWednesday),
  i18n(I18nKey.calendarThursday),
  i18n(I18nKey.calendarFriday),
  i18n(I18nKey.calendarSaturday),
];

const yearText = i18n(I18nKey.year);
const currentLang = siteConfig.lang || "en";
---

<WidgetLayout id="calendar-widget" class={className} style={style}>
  <span slot="title-icon" id="calendar-widget-title" class="flex-1 text-left"></span>
  <div class="calendar-container">
    <div class="weekdays grid grid-cols-7 gap-1 mb-2">
      {
        weekDays.map((day) => (
          <div class="text-center text-xs text-neutral-500 dark:text-neutral-400 font-medium">
            {day}
          </div>
        ))
      }
    </div>

    <div class="calendar-grid grid grid-cols-7 gap-1" id="calendar-grid"></div>

    <div id="calendar-posts" class="mt-3">
      <div
        class="border-t border-neutral-200 dark:border-neutral-700 mb-2"
        id="calendar-posts-divider"
        style="display: none;"
      ></div>
      <div class="flex flex-col gap-1" id="calendar-posts-list"></div>
    </div>
  </div>
</WidgetLayout>

<script
  is:inline
  define:vars={{
    postDateMap: Object.fromEntries(postDateMap),
    allPostsData,
    monthNames,
    yearText,
    currentLang,
  }}
>
  const postLinkClass =
    "block text-sm text-neutral-700 dark:text-neutral-300 hover:text-[var(--primary)] dark:hover:text-[var(--primary)] transition-colors truncate px-2 py-1 rounded hover:bg-[var(--btn-plain-bg-hover)]";

  function toPostUrl(postId) {
    const encodedId = String(postId)
      .split("/")
      .map((segment) => encodeURIComponent(segment))
      .join("/");
    return `/posts/${encodedId}/`;
  }

  function createPostLinkElement(post) {
    const link = document.createElement("a");
    link.href = toPostUrl(post.id);
    link.className = postLinkClass;
    link.textContent = String(post.title || "");
    return link;
  }

  function renderPostsList(postsList, posts) {
    postsList.replaceChildren();
    posts.forEach((post) => {
      postsList.appendChild(createPostLinkElement(post));
    });
  }

  function renderCalendar() {
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth();
    const currentDate = now.getDate();

    const titleElement = document.getElementById("calendar-widget-title");
    if (titleElement) {
      if (currentLang.startsWith("zh") || currentLang.startsWith("ja")) {
        titleElement.textContent = `${currentYear}${yearText}${monthNames[currentMonth]}`;
      } else {
        titleElement.textContent = `${monthNames[currentMonth]} ${currentYear}`;
      }
    }

    const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

    const calendarGrid = document.getElementById("calendar-grid");
    if (!calendarGrid) return;

    const calendarDays = [];
    for (let index = 0; index < firstDayOfMonth; index++) {
      calendarDays.push({ day: null, hasPost: false, count: 0, dateKey: "" });
    }

    for (let day = 1; day <= daysInMonth; day++) {
      const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
      const dailyPosts = postDateMap[dateKey] || [];
      calendarDays.push({
        day,
        hasPost: dailyPosts.length > 0,
        count: dailyPosts.length,
        dateKey,
      });
    }

    const fragment = document.createDocumentFragment();
    calendarDays.forEach(({ day, hasPost, count, dateKey }) => {
      const isToday = day === currentDate;
      const cell = document.createElement("div");
      const classes = [
        "calendar-day",
        "aspect-square",
        "flex",
        "items-center",
        "justify-center",
        "rounded",
        "text-sm",
        "relative",
        "cursor-pointer",
      ];

      if (!day) {
        classes.push("text-neutral-400", "dark:text-neutral-600");
      } else if (!hasPost) {
        classes.push("text-neutral-700", "dark:text-neutral-300");
      } else {
        classes.push("text-neutral-900", "dark:text-neutral-100", "font-bold");
      }

      if (isToday) {
        classes.push("ring-2", "ring-[var(--primary)]");
      }

      cell.className = classes.join(" ");
      cell.setAttribute("data-date", dateKey);
      cell.setAttribute("data-has-post", String(hasPost));
      if (day) {
        cell.textContent = String(day);
      }

      if (hasPost) {
        const marker = document.createElement("span");
        marker.className =
          "absolute bottom-0 left-1/2 -translate-x-1/2 w-1 h-1 rounded-full bg-[var(--primary)]";
        cell.appendChild(marker);
      }

      if (hasPost && count > 1) {
        const badge = document.createElement("span");
        badge.className =
          "absolute top-0 right-0 text-[10px] text-[var(--primary)] font-bold";
        badge.textContent = String(count);
        cell.appendChild(badge);
      }

      fragment.appendChild(cell);
    });

    calendarGrid.replaceChildren(fragment);

    const currentMonthPosts = allPostsData.filter((post) => {
      const publishedDate = new Date(post.published);
      return (
        publishedDate.getFullYear() === currentYear &&
        publishedDate.getMonth() === currentMonth
      );
    });

    showMonthlyPosts(currentMonthPosts);
    setupClickHandlers(currentMonthPosts);
  }

  function showMonthlyPosts(currentMonthPosts) {
    const postsList = document.getElementById("calendar-posts-list");
    const divider = document.getElementById("calendar-posts-divider");

    if (!postsList) return;

    renderPostsList(postsList, currentMonthPosts);

    if (divider) {
      divider.style.display = currentMonthPosts.length > 0 ? "block" : "none";
    }
  }

  function setupClickHandlers(currentMonthPosts) {
    const calendarDays = document.querySelectorAll(".calendar-day[data-date]");
    const postsList = document.getElementById("calendar-posts-list");
    const divider = document.getElementById("calendar-posts-divider");

    let currentSelectedDay = null;

    calendarDays.forEach((dayElement) => {
      dayElement.addEventListener("click", () => {
        const dateKey = dayElement.getAttribute("data-date");
        const hasPost = dayElement.getAttribute("data-has-post") === "true";

        if (!hasPost || !dateKey) return;

        if (currentSelectedDay === dayElement) {
          dayElement.classList.remove("bg-[var(--primary)]", "bg-opacity-10");
          currentSelectedDay = null;
          showMonthlyPosts(currentMonthPosts);
          return;
        }

        if (currentSelectedDay) {
          currentSelectedDay.classList.remove("bg-[var(--primary)]", "bg-opacity-10");
        }

        dayElement.classList.add("bg-[var(--primary)]", "bg-opacity-10");
        currentSelectedDay = dayElement;

        const posts = postDateMap[dateKey] || [];
        if (posts.length > 0 && postsList) {
          renderPostsList(postsList, posts);
          if (divider) {
            divider.style.display = "block";
          }
        }
      });
    });
  }

  renderCalendar();

  const calendarWidgetState =
    window.__calendarWidgetState ||
    (window.__calendarWidgetState = {
      midnightTimeoutId: null,
      dailyIntervalId: null,
      swupHandler: null,
    });

  const now = new Date();
  const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
  const msUntilMidnight = tomorrow.getTime() - now.getTime();

  if (calendarWidgetState.midnightTimeoutId) {
    clearTimeout(calendarWidgetState.midnightTimeoutId);
    calendarWidgetState.midnightTimeoutId = null;
  }

  if (calendarWidgetState.dailyIntervalId) {
    clearInterval(calendarWidgetState.dailyIntervalId);
    calendarWidgetState.dailyIntervalId = null;
  }

  calendarWidgetState.midnightTimeoutId = setTimeout(() => {
    renderCalendar();
    calendarWidgetState.dailyIntervalId = setInterval(
      renderCalendar,
      24 * 60 * 60 * 1000,
    );
  }, msUntilMidnight);

  if (!calendarWidgetState.swupHandler) {
    calendarWidgetState.swupHandler = () => {
      setTimeout(renderCalendar, 100);
    };
    document.addEventListener("swup:contentReplaced", calendarWidgetState.swupHandler);
  }
</script>

<style>
  .calendar-day {
    transition: all 0.2s ease;
    min-height: 32px;
  }

  .calendar-day[data-has-post="true"]:hover {
    transform: translateY(-2px);
  }
</style>
